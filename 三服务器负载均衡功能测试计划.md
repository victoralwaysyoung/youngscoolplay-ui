# YoungsCoolPlay UI 三服务器负载均衡功能测试计划

## 📋 测试概述

本测试计划旨在验证 YoungsCoolPlay UI 在三服务器架构下的负载均衡功能，包括：
- 1台日本服务器（IP池节点）- 配置2个静态住宅IP
- 2台上海服务器（中转节点）- 负载均衡配置
- 客户端通过切换vless配置验证IP轮换和负载均衡

## 🏗️ 服务器架构设计

### 架构图
```
客户端 (Your PC)
    ↓ (vless连接)
上海服务器1 (中转节点1) ←→ 负载均衡 ←→ 上海服务器2 (中转节点2)
    ↓                                    ↓
日本服务器 (IP池节点)
    ├── 静态住宅IP1 (出口IP1)
    └── 静态住宅IP2 (出口IP2)
```

### 服务器角色分配

| 服务器 | 角色 | 功能 | IP配置 |
|--------|------|------|--------|
| 日本服务器 | IP池节点 | 提供多个出口IP，配置IP轮换 | 2个静态住宅IP |
| 上海服务器1 | 中转节点1 | 接收客户端连接，转发到日本 | 1个公网IP |
| 上海服务器2 | 中转节点2 | 接收客户端连接，转发到日本 | 1个公网IP |

## 🚀 第一阶段：服务器部署

### 1.1 日本服务器（IP池节点）部署

#### 1.1.1 系统准备
```bash
# 1. 登录日本服务器
ssh root@[日本服务器IP]

# 2. 更新系统
apt update && apt upgrade -y

# 3. 安装必要工具
apt install -y curl wget unzip git
```

#### 1.1.2 下载和安装 YoungsCoolPlay UI
```bash
# 1. 下载最新版本
cd /opt
wget https://github.com/victoralwaysyoung/youngscoolplay-ui/releases/download/v1.0.0/youngscoolplay-ui-production.zip

# 2. 解压安装包
unzip youngscoolplay-ui-production.zip
cd youngscoolplay-ui-production

# 3. 运行安装脚本
chmod +x install.sh
./install.sh

# 4. 验证安装
systemctl status youngscoolplay-ui
```

#### 1.1.3 配置IP池（关键步骤）
```bash
# 1. 登录Web管理界面
# 浏览器访问: http://[日本服务器IP]:54321
# 默认用户名: admin
# 默认密码: admin

# 2. 首次登录配置
# - 勾选"我已阅读并同意服务条款"
# - 点击"登录"
# - 系统会提示修改默认密码，设置新密码

# 3. 配置静态住宅IP
# 进入"设置" -> "Xray配置" -> "出站设置"
```

#### 1.1.4 Web界面详细配置步骤

**步骤1: 登录系统**
1. 打开浏览器，访问 `http://[日本服务器IP]:54321`
2. 输入用户名: `admin`，密码: `admin`
3. 勾选"我已阅读并同意服务条款"
4. 点击"登录"按钮
5. 系统提示修改密码，输入新密码并确认

**步骤2: 配置出站规则**
1. 点击左侧菜单"设置"
2. 点击"Xray配置"标签
3. 点击"出站设置"
4. 点击"添加出站"按钮（绿色加号）

**步骤3: 配置第一个静态IP出站**
```json
{
  "tag": "static-ip-1",
  "protocol": "freedom",
  "settings": {
    "domainStrategy": "UseIP"
  },
  "streamSettings": {
    "sockopt": {
      "bindAddr": "[静态住宅IP1]"
    }
  }
}
```

**步骤4: 配置第二个静态IP出站**
```json
{
  "tag": "static-ip-2", 
  "protocol": "freedom",
  "settings": {
    "domainStrategy": "UseIP"
  },
  "streamSettings": {
    "sockopt": {
      "bindAddr": "[静态住宅IP2]"
    }
  }
}
```

**步骤5: 配置路由规则**
1. 点击"路由设置"
2. 点击"添加路由规则"
3. 配置IP轮换规则：
```json
{
  "type": "field",
  "balancerTag": "ip-balancer"
}
```

**步骤6: 配置负载均衡器**
```json
{
  "tag": "ip-balancer",
  "selector": ["static-ip-1", "static-ip-2"],
  "strategy": {
    "type": "roundRobin"
  }
}
```

#### 1.1.5 配置入站规则
**步骤1: 添加入站规则**
1. 点击左侧菜单"入站列表"
2. 点击"添加入站"按钮（绿色加号）

**步骤2: 配置VLESS入站**
- **备注**: `Japan-IP-Pool`
- **协议**: `vless`
- **监听IP**: `0.0.0.0`
- **端口**: `443`
- **传输协议**: `tcp`
- **TLS**: 启用
- **域名**: `[你的域名或IP]`

**步骤3: 添加客户端**
1. 在入站规则中点击"操作" -> "添加客户端"
2. 设置客户端ID（自动生成UUID）
3. 设置客户端备注: `Client-1`
4. 点击"添加"

### 1.2 上海服务器1（中转节点1）部署

#### 1.2.1 系统准备和安装
```bash
# 1. 登录上海服务器1
ssh root@[上海服务器1IP]

# 2. 系统更新和安装
apt update && apt upgrade -y
apt install -y curl wget unzip git

# 3. 下载安装包
cd /opt
wget https://github.com/victoralwaysyoung/youngscoolplay-ui/releases/download/v1.0.0/youngscoolplay-ui-production.zip
unzip youngscoolplay-ui-production.zip
cd youngscoolplay-ui-production

# 4. 安装
chmod +x install.sh
./install.sh
```

#### 1.2.2 Web界面配置

**步骤1: 登录配置**
1. 访问 `http://[上海服务器1IP]:54321`
2. 登录并修改密码

**步骤2: 配置出站到日本服务器**
1. 进入"设置" -> "Xray配置" -> "出站设置"
2. 点击"添加出站"
3. 配置连接到日本服务器：
```json
{
  "tag": "to-japan",
  "protocol": "vless",
  "settings": {
    "vnext": [
      {
        "address": "[日本服务器IP]",
        "port": 443,
        "users": [
          {
            "id": "[日本服务器客户端UUID]",
            "encryption": "none"
          }
        ]
      }
    ]
  },
  "streamSettings": {
    "network": "tcp",
    "security": "tls",
    "tlsSettings": {
      "serverName": "[日本服务器域名或IP]"
    }
  }
}
```

**步骤3: 配置入站规则**
1. 进入"入站列表"
2. 添加入站规则：
- **备注**: `Shanghai-Relay-1`
- **协议**: `vless`
- **监听IP**: `0.0.0.0`
- **端口**: `443`
- **传输协议**: `tcp`
- **TLS**: 启用

**步骤4: 配置路由规则**
```json
{
  "type": "field",
  "outboundTag": "to-japan"
}
```

### 1.3 上海服务器2（中转节点2）部署

#### 1.3.1 重复上海服务器1的部署步骤
```bash
# 登录上海服务器2
ssh root@[上海服务器2IP]

# 执行相同的安装步骤...
```

#### 1.3.2 配置差异
- 入站备注改为: `Shanghai-Relay-2`
- 其他配置与上海服务器1相同

## 🔧 第二阶段：负载均衡配置

### 2.1 客户端负载均衡配置

#### 2.1.1 创建客户端配置文件

**配置文件1: shanghai-relay-1.json**
```json
{
  "log": {
    "loglevel": "info"
  },
  "inbounds": [
    {
      "port": 1080,
      "protocol": "socks",
      "settings": {
        "udp": true
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "vless",
      "settings": {
        "vnext": [
          {
            "address": "[上海服务器1IP]",
            "port": 443,
            "users": [
              {
                "id": "[上海服务器1客户端UUID]",
                "encryption": "none"
              }
            ]
          }
        ]
      },
      "streamSettings": {
        "network": "tcp",
        "security": "tls",
        "tlsSettings": {
          "serverName": "[上海服务器1域名或IP]"
        }
      },
      "tag": "shanghai-1"
    }
  ]
}
```

**配置文件2: shanghai-relay-2.json**
```json
{
  "log": {
    "loglevel": "info"
  },
  "inbounds": [
    {
      "port": 1081,
      "protocol": "socks",
      "settings": {
        "udp": true
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "vless",
      "settings": {
        "vnext": [
          {
            "address": "[上海服务器2IP]",
            "port": 443,
            "users": [
              {
                "id": "[上海服务器2客户端UUID]",
                "encryption": "none"
              }
            ]
          }
        ]
      },
      "streamSettings": {
        "network": "tcp",
        "security": "tls",
        "tlsSettings": {
          "serverName": "[上海服务器2域名或IP]"
        }
      },
      "tag": "shanghai-2"
    }
  ]
}
```

## 🧪 第三阶段：功能测试

### 3.1 连接测试

#### 3.1.1 启动客户端连接
```bash
# 启动连接到上海服务器1
xray -config shanghai-relay-1.json &

# 启动连接到上海服务器2  
xray -config shanghai-relay-2.json &
```

#### 3.1.2 基础连接验证
```bash
# 测试通过上海服务器1的连接
curl --proxy socks5://127.0.0.1:1080 http://ipinfo.io

# 测试通过上海服务器2的连接
curl --proxy socks5://127.0.0.1:1081 http://ipinfo.io
```

### 3.2 IP轮换测试

#### 3.2.1 连续IP检测脚本
```bash
#!/bin/bash
# ip-rotation-test.sh

echo "=== IP轮换测试开始 ==="
echo "测试时间: $(date)"
echo ""

# 测试上海服务器1路由的IP轮换
echo "--- 上海服务器1 IP轮换测试 ---"
for i in {1..10}; do
    IP=$(curl -s --proxy socks5://127.0.0.1:1080 http://ipinfo.io/ip)
    echo "请求 $i: $IP"
    sleep 2
done

echo ""

# 测试上海服务器2路由的IP轮换
echo "--- 上海服务器2 IP轮换测试 ---"
for i in {1..10}; do
    IP=$(curl -s --proxy socks5://127.0.0.1:1081 http://ipinfo.io/ip)
    echo "请求 $i: $IP"
    sleep 2
done

echo ""
echo "=== IP轮换测试完成 ==="
```

#### 3.2.2 执行测试
```bash
chmod +x ip-rotation-test.sh
./ip-rotation-test.sh
```

### 3.3 负载均衡验证

#### 3.3.1 并发连接测试脚本
```bash
#!/bin/bash
# load-balance-test.sh

echo "=== 负载均衡测试开始 ==="

# 创建测试函数
test_server() {
    local proxy_port=$1
    local server_name=$2
    local test_count=$3
    
    echo "--- $server_name 并发测试 ---"
    
    for i in $(seq 1 $test_count); do
        {
            IP=$(curl -s --proxy socks5://127.0.0.1:$proxy_port http://ipinfo.io/ip)
            echo "[$server_name] 连接 $i: $IP"
        } &
    done
    
    wait
    echo ""
}

# 测试上海服务器1
test_server 1080 "上海服务器1" 5

# 测试上海服务器2
test_server 1081 "上海服务器2" 5

echo "=== 负载均衡测试完成 ==="
```

### 3.4 切换测试

#### 3.4.1 手动切换测试
```bash
#!/bin/bash
# switch-test.sh

echo "=== 服务器切换测试 ==="

# 测试切换函数
switch_test() {
    echo "当前使用上海服务器1:"
    curl --proxy socks5://127.0.0.1:1080 http://ipinfo.io
    echo ""
    
    echo "切换到上海服务器2:"
    curl --proxy socks5://127.0.0.1:1081 http://ipinfo.io
    echo ""
    
    echo "再次切换回上海服务器1:"
    curl --proxy socks5://127.0.0.1:1080 http://ipinfo.io
    echo ""
}

# 执行切换测试
for round in {1..3}; do
    echo "--- 第 $round 轮切换测试 ---"
    switch_test
    sleep 5
done

echo "=== 切换测试完成 ==="
```

## 📊 第四阶段：监控和验证

### 4.1 服务器状态监控

#### 4.1.1 日本服务器监控
```bash
# 登录日本服务器
ssh root@[日本服务器IP]

# 查看服务状态
systemctl status youngscoolplay-ui

# 查看实时日志
journalctl -u youngscoolplay-ui -f

# 查看连接统计
ss -tuln | grep :443

# 查看网络接口和IP绑定
ip addr show
```

#### 4.1.2 上海服务器监控
```bash
# 分别登录两台上海服务器执行相同命令

# 查看服务状态
systemctl status youngscoolplay-ui

# 查看连接数
ss -tuln | grep :443
netstat -an | grep :443 | wc -l

# 查看流量统计
iftop -i eth0
```

### 4.2 Web界面监控

#### 4.2.1 访问管理界面
1. **日本服务器**: `http://[日本服务器IP]:54321`
2. **上海服务器1**: `http://[上海服务器1IP]:54321`
3. **上海服务器2**: `http://[上海服务器2IP]:54321`

#### 4.2.2 检查关键指标
- **入站连接数**: 查看"入站列表"中的连接统计
- **流量统计**: 查看"系统状态"中的流量数据
- **在线用户**: 查看当前活跃连接数
- **系统资源**: CPU、内存、网络使用率

### 4.3 详细验证步骤

#### 4.3.1 IP池验证清单
- [ ] 日本服务器配置了2个静态住宅IP出站
- [ ] IP轮换策略配置为roundRobin
- [ ] 连续请求能看到IP在两个地址间轮换
- [ ] 每个IP都能正常访问外网

#### 4.3.2 中转节点验证清单
- [ ] 上海服务器1能正常连接到日本服务器
- [ ] 上海服务器2能正常连接到日本服务器
- [ ] 客户端能通过两台上海服务器访问网络
- [ ] 流量正确转发到日本服务器

#### 4.3.3 负载均衡验证清单
- [ ] 客户端能在两个上海服务器间切换
- [ ] 并发连接时流量分布均匀
- [ ] 单个服务器故障时另一个能正常工作
- [ ] 切换过程中连接不中断

## 🔧 第五阶段：故障排除

### 5.1 常见问题诊断

#### 5.1.1 连接失败
```bash
# 检查端口是否开放
telnet [服务器IP] 443

# 检查防火墙
ufw status
iptables -L

# 检查服务状态
systemctl status youngscoolplay-ui
```

#### 5.1.2 IP轮换不工作
```bash
# 检查出站配置
cat /etc/youngscoolplay-ui/config.json | jq '.outbounds'

# 检查路由规则
cat /etc/youngscoolplay-ui/config.json | jq '.routing'

# 检查IP绑定
ip addr show
```

#### 5.1.3 负载不均衡
```bash
# 检查连接数分布
ss -tuln | grep :443 | wc -l

# 检查流量统计
iftop -i eth0

# 检查系统负载
htop
```

### 5.2 日志分析

#### 5.2.1 关键日志位置
- **系统日志**: `/var/log/youngscoolplay-ui/`
- **Xray日志**: `/var/log/xray/`
- **系统服务日志**: `journalctl -u youngscoolplay-ui`

#### 5.2.2 日志分析命令
```bash
# 查看错误日志
grep -i error /var/log/youngscoolplay-ui/*.log

# 查看连接日志
grep -i "accepted" /var/log/xray/access.log

# 实时监控
tail -f /var/log/youngscoolplay-ui/app.log
```

## 📈 第六阶段：性能测试

### 6.1 带宽测试
```bash
# 通过代理测试下载速度
curl --proxy socks5://127.0.0.1:1080 -o /dev/null -s -w "%{speed_download}\n" http://speedtest.tele2.net/100MB.zip

# 测试上传速度
curl --proxy socks5://127.0.0.1:1080 -T large_file.zip http://httpbin.org/post
```

### 6.2 延迟测试
```bash
# 测试延迟
for i in {1..10}; do
    time curl --proxy socks5://127.0.0.1:1080 -s http://www.google.com > /dev/null
done
```

### 6.3 并发测试
```bash
# 并发连接测试
for i in {1..50}; do
    curl --proxy socks5://127.0.0.1:1080 http://ipinfo.io &
done
wait
```

## 📋 测试报告模板

### 测试结果记录表

| 测试项目 | 预期结果 | 实际结果 | 状态 | 备注 |
|---------|---------|---------|------|------|
| 日本服务器部署 | 成功安装并启动 | | ✅/❌ | |
| 上海服务器1部署 | 成功安装并启动 | | ✅/❌ | |
| 上海服务器2部署 | 成功安装并启动 | | ✅/❌ | |
| IP池配置 | 2个IP轮换 | | ✅/❌ | |
| 中转连接 | 正常转发流量 | | ✅/❌ | |
| 负载均衡 | 流量均匀分布 | | ✅/❌ | |
| IP切换 | 手动切换正常 | | ✅/❌ | |
| 并发测试 | 支持多连接 | | ✅/❌ | |
| 性能测试 | 满足带宽要求 | | ✅/❌ | |

### IP轮换记录表

| 请求序号 | 上海服务器1出口IP | 上海服务器2出口IP | 轮换正常 |
|---------|-----------------|-----------------|---------|
| 1 | | | |
| 2 | | | |
| 3 | | | |
| ... | | | |

## 🎯 验收标准

### 功能验收标准
1. ✅ 所有服务器成功部署YoungsCoolPlay UI
2. ✅ 日本服务器IP池正常轮换（2个静态IP）
3. ✅ 上海服务器正常转发流量到日本
4. ✅ 客户端能在两个上海服务器间切换
5. ✅ 负载均衡分布合理（误差<20%）
6. ✅ 单点故障时系统仍可用
7. ✅ 性能满足预期（延迟<500ms，带宽>10Mbps）

### 稳定性验收标准
1. ✅ 连续运行24小时无中断
2. ✅ 1000次IP切换测试成功率>99%
3. ✅ 并发100连接稳定运行
4. ✅ 内存使用率<80%，CPU使用率<70%

---

## 📞 技术支持

如测试过程中遇到问题，请参考：
- **项目文档**: [GitHub仓库](https://github.com/victoralwaysyoung/youngscoolplay-ui) <mcreference link="https://github.com/victoralwaysyoung/youngscoolplay-ui/releases/tag/v1.0.0" index="0">0</mcreference>
- **故障排除**: `TROUBLESHOOTING.md`
- **部署指南**: `DEPLOYMENT_GUIDE.md`

**测试完成后请保存所有配置文件和测试结果，以便后续维护和优化。**